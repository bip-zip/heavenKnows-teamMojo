{% extends 'base.html' %}
{% load static %}
{% block title %} BusinessRegister {% endblock title %}
{% block heading %} Business Register {% endblock heading %}
{% block content %}
    <div class="flex flex-col md:flex-row items-center justify-center md:justify-between w-full md:w-11/12 lg:w-4/5 mx-auto">

        <!-- Registration Form -->
        <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8 md:p-10 w-full">
            
            <!-- Progress Steps -->
            <div class="mb-8">
                <div class="flex items-center justify-between relative">
                    <!-- Progress Bar Background -->
                    <div class="absolute top-5 left-0 w-full h-1 bg-gray-200 -z-10"></div>
                    <div id="progressBar" class="absolute top-5 left-0 h-1 bg-green-600 transition-all duration-500 ease-in-out -z-10" style="width: 0%"></div>
                    
                    <!-- Step 1 -->
                    <div class="flex flex-col items-center relative">
                        <div id="step1Circle" class="w-10 h-10 rounded-full bg-green-600 text-white flex items-center justify-center font-semibold z-10 transition-all duration-300">
                            1
                        </div>
                        <span class="text-xs mt-2 font-medium text-gray-700 absolute top-12 whitespace-nowrap">Account Info</span>
                    </div>
                    
                    <!-- Step 2 -->
                    <div class="flex flex-col items-center relative">
                        <div id="step2Circle" class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-semibold z-10 transition-all duration-300">
                            2
                        </div>
                        <span class="text-xs mt-2 font-medium text-gray-500 absolute top-12 whitespace-nowrap">Business Info</span>
                    </div>
                    
                    <!-- Step 3 -->
                    <div class="flex flex-col items-center relative">
                        <div id="step3Circle" class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-semibold z-10 transition-all duration-300">
                            3
                        </div>
                        <span class="text-xs mt-2 font-medium text-gray-500 absolute top-12 whitespace-nowrap">Location & Docs</span>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            {% if messages %}
                <div class="mb-6 space-y-3">
                    {% for message in messages %}
                        <div class="{% if message.tags == 'error' %}bg-red-50 border-l-4 border-red-500 text-red-800{% elif message.tags == 'success' %}bg-green-50 border-l-4 border-green-500 text-green-800{% else %}bg-blue-50 border-l-4 border-blue-500 text-blue-800{% endif %} rounded-lg px-4 py-3 flex items-start">
                            <svg class="w-5 h-5 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <span>{{ message }}</span>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="registrationForm" class="space-y-8">
                {% csrf_token %}
                
                <!-- Step 1: Account Information -->
                <div id="step1" class="step-content">
                    <div class="flex items-center mb-4 pb-2 border-b-2 border-green-500">
                        <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <h2 class="text-2xl font-semibold text-gray-800">Account Information</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Email Address <span class="text-red-500">*</span>
                            </label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.email.errors.0 }}</p>
                            {% endif %}
                            <p class="error-message text-sm text-red-600 mt-1 hidden"></p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Contact Number <span class="text-red-500">*</span>
                            </label>
                            {{ form.contact }}
                            {% if form.contact.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.contact.errors.0 }}</p>
                            {% endif %}
                            <p class="error-message text-sm text-red-600 mt-1 hidden"></p>
                        </div>
                        
                        <div></div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Password <span class="text-red-500">*</span>
                            </label>
                            {{ form.password }}
                            {% if form.password.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.password.errors.0 }}</p>
                            {% else %}
                                <p class="mt-1 text-xs text-gray-500">Minimum 8 characters</p>
                            {% endif %}
                            <p class="error-message text-sm text-red-600 mt-1 hidden"></p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Confirm Password <span class="text-red-500">*</span>
                            </label>
                            {{ form.password_confirm }}
                            {% if form.password_confirm.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.password_confirm.errors.0 }}</p>
                            {% endif %}
                            <p class="error-message text-sm text-red-600 mt-1 hidden"></p>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Business Information -->
                <div id="step2" class="step-content hidden">
                    <div class="flex items-center mb-4 pb-2 border-b-2 border-green-500">
                        <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <h2 class="text-2xl font-semibold text-gray-800">Business Information</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Business Name <span class="text-red-500">*</span>
                            </label>
                            {{ form.business_name }}
                            {% if form.business_name.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.business_name.errors.0 }}</p>
                            {% endif %}
                            <p class="error-message text-sm text-red-600 mt-1 hidden"></p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Business Type <span class="text-red-500">*</span>
                            </label>
                            {{ form.business_type }}
                            {% if form.business_type.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.business_type.errors.0 }}</p>
                            {% endif %}
                            <p class="error-message text-sm text-red-600 mt-1 hidden"></p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                PAN/VAT Number <span class="text-red-500">*</span>
                            </label>
                            {{ form.pan_or_vat }}
                            {% if form.pan_or_vat.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.pan_or_vat.errors.0 }}</p>
                            {% endif %}
                            <p class="error-message text-sm text-red-600 mt-1 hidden"></p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Business Phone <span class="text-red-500">*</span>
                            </label>
                            {{ form.phone }}
                            {% if form.phone.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.phone.errors.0 }}</p>
                            {% endif %}
                            <p class="error-message text-sm text-red-600 mt-1 hidden"></p>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Website
                            </label>
                            {{ form.website }}
                            {% if form.website.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.website.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Business Description
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Step 3: Location & Documents -->
                <div id="step3" class="step-content hidden">
                    <!-- Location Information -->
                    <div class="mb-8">
                        <div class="flex items-center mb-4 pb-2 border-b-2 border-green-500">
                            <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <h2 class="text-2xl font-semibold text-gray-800">Location Information</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Address <span class="text-red-500">*</span>
                                </label>
                                {{ form.address }}
                                {% if form.address.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.address.errors.0 }}</p>
                                {% endif %}
                                <p class="error-message text-sm text-red-600 mt-1 hidden"></p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    District <span class="text-red-500">*</span>
                                </label>
                                {{ form.district }}
                                {% if form.district.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.district.errors.0 }}</p>
                                {% endif %}
                                <p class="error-message text-sm text-red-600 mt-1 hidden"></p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Province <span class="text-red-500">*</span>
                                </label>
                                {{ form.province }}
                                {% if form.province.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.province.errors.0 }}</p>
                                {% endif %}
                                <p class="error-message text-sm text-red-600 mt-1 hidden"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Documents -->
                    <div>
                        <div class="flex items-center mb-4 pb-2 border-b-2 border-green-500">
                            <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h2 class="text-2xl font-semibold text-gray-800">Required Documents</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Registration Document <span class="text-red-500">*</span>
                                </label>
                                <p class="text-xs text-gray-500 mb-2">Upload your business registration certificate (PDF, JPG, PNG)</p>
                                {{ form.registration_document }}
                                {% if form.registration_document.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.registration_document.errors.0 }}</p>
                                {% endif %}
                                <p class="error-message text-sm text-red-600 mt-1 hidden"></p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Request Letter <span class="text-red-500">*</span>
                                </label>
                                <p class="text-xs text-gray-500 mb-2">Upload your partnership request letter (PDF, JPG, PNG)</p>
                                {{ form.request_letter }}
                                {% if form.request_letter.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.request_letter.errors.0 }}</p>
                                {% endif %}
                                <p class="error-message text-sm text-red-600 mt-1 hidden"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Errors -->
                {% if form.non_field_errors %}
                    <div class="bg-red-50 border-l-4 border-red-500 rounded-lg px-4 py-3">
                        {% for error in form.non_field_errors %}
                            <p class="text-red-800 text-sm">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Navigation Buttons -->
                <div class="pt-6 flex justify-between items-center">
                    <button type="button" id="prevBtn" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-8 rounded-lg transition duration-300">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Previous
                    </button>
                    
                    <button type="button" id="nextBtn" class="ml-auto bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transition duration-300 transform hover:scale-[1.02]">
                        Next
                        <svg class="w-5 h-5 inline ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                    
                    <button type="submit" id="submitBtn" class="hidden ml-auto bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transition duration-300 transform hover:scale-[1.02]">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Register Business
                    </button>
                </div>

                <p class="text-center text-sm text-gray-600 mt-4">
                    Already have an account? 
                    <a href="#" class="text-green-600 hover:text-green-700 font-medium underline">Login here</a>
                </p>
            </form>
        </div>
    </div>

    <script>
        // Multi-step form logic
        let currentStep = 1;
        const totalSteps = 3;

        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        
        const step1Circle = document.getElementById('step1Circle');
        const step2Circle = document.getElementById('step2Circle');
        const step3Circle = document.getElementById('step3Circle');
        
        const progressBar = document.getElementById('progressBar');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        // Show/hide steps
        function showStep(step) {
            // Hide all steps
            step1.classList.add('hidden');
            step2.classList.add('hidden');
            step3.classList.add('hidden');

            // Show current step
            if (step === 1) {
                step1.classList.remove('hidden');
            } else if (step === 2) {
                step2.classList.remove('hidden');
            } else if (step === 3) {
                step3.classList.remove('hidden');
            }

            // Update progress bar
            const progress = ((step - 1) / (totalSteps - 1)) * 100;
            progressBar.style.width = progress + '%';

            // Update step circles
            updateStepCircles(step);

            // Update buttons
            updateButtons(step);
        }

        function updateStepCircles(step) {
            // Reset all circles
            step1Circle.classList.remove('bg-green-600', 'text-white');
            step2Circle.classList.remove('bg-green-600', 'text-white');
            step3Circle.classList.remove('bg-green-600', 'text-white');
            
            step1Circle.classList.add('bg-gray-200', 'text-gray-500');
            step2Circle.classList.add('bg-gray-200', 'text-gray-500');
            step3Circle.classList.add('bg-gray-200', 'text-gray-500');

            // Activate current and previous steps
            if (step >= 1) {
                step1Circle.classList.remove('bg-gray-200', 'text-gray-500');
                step1Circle.classList.add('bg-green-600', 'text-white');
            }
            if (step >= 2) {
                step2Circle.classList.remove('bg-gray-200', 'text-gray-500');
                step2Circle.classList.add('bg-green-600', 'text-white');
            }
            if (step >= 3) {
                step3Circle.classList.remove('bg-gray-200', 'text-gray-500');
                step3Circle.classList.add('bg-green-600', 'text-white');
            }
        }

        function updateButtons(step) {
            // Previous button
            if (step === 1) {
                prevBtn.classList.add('hidden');
            } else {
                prevBtn.classList.remove('hidden');
            }

            // Next/Submit buttons
            if (step === totalSteps) {
                nextBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
            }
        }

        // Validate current step
        function validateStep(step) {
            let isValid = true;
            let currentStepElement;

            if (step === 1) currentStepElement = step1;
            else if (step === 2) currentStepElement = step2;
            else if (step === 3) currentStepElement = step3;

            // Clear previous errors
            const errorMessages = currentStepElement.querySelectorAll('.error-message');
            errorMessages.forEach(msg => {
                msg.classList.add('hidden');
                msg.textContent = '';
            });

            // Get all required inputs in current step
            const requiredInputs = currentStepElement.querySelectorAll('input[required], select[required], textarea[required]');
            
            requiredInputs.forEach(input => {
                const errorMsg = input.parentElement.querySelector('.error-message');
                
                if (!input.value.trim()) {
                    isValid = false;
                    if (errorMsg) {
                        errorMsg.textContent = 'This field is required.';
                        errorMsg.classList.remove('hidden');
                    }
                    input.classList.add('border-red-500');
                } else {
                    input.classList.remove('border-red-500');
                }

                // Special validation for email
                if (input.type === 'email' && input.value.trim()) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(input.value)) {
                        isValid = false;
                        if (errorMsg) {
                            errorMsg.textContent = 'Please enter a valid email address.';
                            errorMsg.classList.remove('hidden');
                        }
                        input.classList.add('border-red-500');
                    }
                }

                // Special validation for password match
                if (input.id && input.id.includes('password_confirm')) {
                    const passwordField = document.querySelector('input[id*="password"]:not([id*="confirm"])');
                    if (passwordField && input.value !== passwordField.value) {
                        isValid = false;
                        if (errorMsg) {
                            errorMsg.textContent = 'Passwords do not match.';
                            errorMsg.classList.remove('hidden');
                        }
                        input.classList.add('border-red-500');
                    }
                }

                // Special validation for password length
                if (input.type === 'password' && !input.id.includes('confirm') && input.value.trim()) {
                    if (input.value.length < 8) {
                        isValid = false;
                        if (errorMsg) {
                            errorMsg.textContent = 'Password must be at least 8 characters long.';
                            errorMsg.classList.remove('hidden');
                        }
                        input.classList.add('border-red-500');
                    }
                }

                // Validate file uploads
                if (input.type === 'file' && input.hasAttribute('required')) {
                    if (!input.files || input.files.length === 0) {
                        isValid = false;
                        if (errorMsg) {
                            errorMsg.textContent = 'Please upload a file.';
                            errorMsg.classList.remove('hidden');
                        }
                        input.classList.add('border-red-500');
                    }
                }
            });

            return isValid;
        }

        // Next button click
        nextBtn.addEventListener('click', function() {
            if (validateStep(currentStep)) {
                if (currentStep < totalSteps) {
                    currentStep++;
                    showStep(currentStep);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        });

        // Previous button click
        prevBtn.addEventListener('click', function() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        // Form submit validation
        document.getElementById('registrationForm').addEventListener('submit', function(e) {
            // Validate all steps before submitting
            let allValid = true;
            for (let i = 1; i <= totalSteps; i++) {
                if (!validateStep(i)) {
                    allValid = false;
                    currentStep = i;
                    showStep(i);
                    break;
                }
            }

            if (!allValid) {
                e.preventDefault();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        // Initialize
        showStep(currentStep);
    </script>

{% endblock %}